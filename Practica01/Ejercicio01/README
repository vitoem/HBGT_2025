# Carpeta 1.SingleEnd
--------------------------------------------

# Para descomprimir y comprimir archivos en formato .gz
#(Utilizar la ayuda para mostrar opciones)
gunzip -h

# Descomprimir
srun --mem 8G -n1 -p q1 gunzip IlluminaReads_NewStyle.fastq.gz

# Comprimir
srun --mem 8G -n1 -p q1 gzip IlluminaReads_NewStyle.fastq

--------------------------------------------

#Para ver el contenido del archivo "IlluminaReads_NewStyle.fastq"
#(presione la tecla q para salir del visualizador)

less Archivo.fastq

#NOTA:Tambien es posible utilizar comandos como head o tail para mostrar en pantalla las 10 primeras/ultimas lineas del archivo (utilizar la ayuda para mostrar ver otras opicones disponibles para estos comandos) 

#Es a menudo importante saber cuantas secuencias se encuentran contenidas en un archivo (ya sean fasta o fastq), en ambos casos, es importante encontrar caracteres específicos que formen parte de los identificadores únicos de cada una de las secuencias, dichos caracteres idealmente deben estar repetidos en todas las secuencias contenidas en el archivo. Para el nuestro ejemplo, es posible contar el número de secuencias contenidas en el archivo "IlluminaReads_NewStyle.fastq" utilizando la siguiente linea de comando

grep -c "@NB501110" IlluminaReads_NewStyle.fastq 

--------------------------------------------

#Para cambiar los valores de calidad del formato ASCII (acronimo ingles de American Standard Code for Information Interchange) a valores númericos de calidad en la escala de Phred
#ASCII: tabla de codigos (http://ascii.cl/es/)
#Phred: valor numerico conocido como la escala de valor de calidad. Logaritmico ligado a la probabilidad de error (Phred Score = 10, probabilidad de error de lectura en esa base 1/10; Score 20, probabilidad 1/100, etc)

#Primero habilitar el modulo que contiene los ejecutables de este ejercicio (fastx)

module load fastx-toolkit/0.0.14/gcc/8.3.1-6qup

#FASTX-Toolkit (http://hannonlab.cshl.edu/fastx_toolkit/) es una coleccion de herramientas de linea de comandos para el preprocesamiento de archivos FASTA/FASTQ. \
#Convertir y cambiar entre diferentes tipos de formatos, cambiar los identifiadores de las secuencias, filtrar con base a la calidad, recortar adaptadores y regiones de mala calidad son solo algunas de la herramientas disponibles.

#Utilizar la ayuda para mostrar opciones
fastq_quality_converter -h

#Ejecutar el siguiente trabajo en modo interactivo: 
#srun es el comando para lanzar un job interactivo con SLURM, las opciones --mem y -n son utilizadas para asignar los recursos de memoria (16GB) y de procesamiento (1 CPU) respectivamente.

srun --mem 16000 -n 1 -p q2 fastq_quality_converter -n -Q33 -i IlluminaReads_NewStyle.fastq -o IlluminaReads_Phred.fastq

#Ver el interior del archivo y anotar los cambios en el archivo de salida en relacion con el original

--------------------------------------------

#Para cambiar el nombre o identificador de las secuencias de la version reciente a versiones anteriores
#En este paso se empleará un porcesador de datos (awk) para realizar alguno cambios sobre el archivo de entrada.

cat IlluminaReads_NewStyle.fastq | awk '{if (NR % 4 == 1) {split($1, arr, ":"); printf "%s_%s:%s:%s:%s:%s#0/%s (%s)\n", arr[1], arr[3], arr[4], arr[5], arr[6], arr[7], substr($2, 1, 1), $0} else if (NR % 4 == 3){print "+"} else {print $0} }' > IlluminaReads_OldStyle01.fastq

#NOTA: Tenga en cuenta que el encabezado original se agrega al final y entre parentesis. Si no desea / necesita esto, simplemente elimine el espacio y el '(% s)' justo antes del '\ n' en la linea de comando.

cat IlluminaReads_NewStyle.fastq | awk '{if (NR % 4 == 1) {split($1, arr, ":"); printf "%s_%s:%s:%s:%s:%s#0/%s\n", arr[1], arr[3], arr[4], arr[5], arr[6], arr[7], substr($2, 1, 1), $0} else if (NR % 4 == 3){print "+"} else {print $0} }' > IlluminaReads_OldStyle02.fastq

--------------------------------------------

#NOTA: Con frecuencia cuando se pretende analizar un conjunto de datos, una gran cantidad de herramientas/programas son necesarias, es importante tener en cuenta que en la mayoria de las ocasiones, 
#es posible realizar los analisis requeridos sin conocimientos amplios en lenguajes de programacion. Repositorios como github. GitHub es una plataforma de desarrollo colaborativo de software para alojar 
#proyectos utilizando el sistema de control que permite ir siguiendo las diferentes versiones/modificaciones. Los codigo fuente se almacenan y por lo general son de acceso publico.

#Para generar los archivos fasta y qual a partir de un archivo fastq usaremos un script de phyton "convert_fastaqual_fastq.py" disponible en Qiime. Para eelo debemos de cargar el ambiente de conda qiime1-1.9.1

conda activate qiime1-1.9.1

#Para mostar el menu de ayuda:
python convert_fastaqual_fastq.py -h

#A partir de un archivo fastq generar los archivo fasta y qual
srun --mem 16000 -n1 -p q2 convert_fastaqual_fastq.py -c fastq_to_fastaqual -f IlluminaReads_NewStyle.fastq

####como alternativa se puede convertir un archivo fastq a fasta con EMboss####
#module load module load emboss/6.6.0/gcc/9.3.0-4geh
srun --mem 8G -n1 -p q1 seqret -sequence IlluminaReads_NewStyle.fastq -outseq IlluminaReads_NewStyle.fasta

#A partir de los archivos fasta y qual, generar un archivo fastq
srun --mem 16000 -n1 convert_fastaqual_fastq.py -c fastaqual_to_fastq -f IlluminaReads_NewStyle.fna -q IlluminaReads_NewStyle.qual

#Visualizar las diferencias entre los archivos generados

--------------------------------------------

#Para analizar la calidad de las secuencias en el archivo fastq utilie el programa FastQC.

#Como existen modulos cargados (module list) y para evitar interferencia entre programas, es recomendable antes de cargar algun otro modulo, limpiar el ambiente de trabajo:
module purge

#q1 module
module load fastqc/0.11.7/gcc/9.3.0-o4ca

srun --mem 16000 -n1 -p q1 fastqc IlluminaReads_NewStyle.fastq

#Debido a que atraves de la linea de comandos no es posible visualizar archivos en ciertos formatos (p.ej. pdf, html entre otros), importe a su máquina local el archivo en formato html generado como resultado del comando previo. Una vez transferido el archivo, acceda al mismo en su maquina local. 

#Para hacer la transferencie utilice la siguiente linea de comando desde una terminal ubicada en el localhost
rsync -av --progress --bwlimit=20000 -e 'ssh -p 49' $USUARIO@201.122.70.15:$PATH_AL_CURSO/Practica01/1.SingleEnd_Reads/*.html .

#Analice todos los datos contenidos en el archivo .html utilizando algun navegador de Internet (Google Chrome, Firefox, etc.)

--------------------------------------------
#Para Filtrar las secuencias con base a valores de calidad determinados es posible utilizar alguna de las herramientas disponible en el paquete FASTX-toolkit. Cargue el modulo correspondiente y ejecute el siguente comando
module load fastx-toolkit/0.0.14/gcc/8.3.1-gofi
srun --mem 16000 -n1 -p q2 fastq_quality_filter -Q33 -q 30 -p 100 -i IlluminaReads_NewStyle.fastq -o IlluminaReads_Filtered01.fastq

#NOTA: Puede utilizar la ayuda para ver otras opciones disponibles, analice el significado de las variable empleadas (-q y -p)
fastq_quality_filter -h

#Otros filtros estan disponibles dependiendo de la necesidades particulares de los datos con los que se trabaja. Ejecute la siguiente linea de comandos, analice el significado de las variables y compare/explique las salidas de ambas herramientas. 

fastq_quality_trimmer -h
srun --mem 16000 -n1 -p q2 fastq_quality_trimmer -Q33 -t 25 -l 30 -i IlluminaReads_NewStyle.fastq -o IlluminaReads_Filtered02.fastq

#Ejecute el programa FastQC para ambos archivos generados (IlluminaReads_Filtered02.fastq y IlluminaReads_Filtered02.fastq), Importe a su maquina locas los archivos de salida (.html) y analice los mismos. 

--------------------------------------------

#Finalmente, también es posible utilizar otro tipo de aproximaciones para hacer el filtado de lectura, como lo son las ventanas móviles. Para ello utilizaremos el programa Trimmomatic
module load trimmomatic/0.38/gcc/8.3.1-jwk4

#Ejecutar el comando:
srun --mem 8G -n2 -p q1 trimmomatic SE -threads 2 -phred33 IlluminaReads_NewStyle.fastq IlluminaReads_Filtered03.fastq LEADING:15 TRAILING:15 SLIDINGWINDOW:4:20 MINLEN:36

#Se pueden realizar otros filtros modificando los parámetros de las ventanas móviles

#Al finalizar comparar los resultados de ambas aproximaciones a través de los resultados de FastQC.


